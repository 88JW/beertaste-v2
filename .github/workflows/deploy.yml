name: Deploy to Home Server

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: self-hosted
    steps:
      - name: Czyszczenie przestrzeni roboczej
        run: rm -rf ./* || true

      - name: Pobranie kodu
        uses: actions/checkout@v4

      - name: Zbudowanie obrazu
        # PRZEKAZUJEMY KLUCZE JAKO ARGUMENTY BUDOWANIA (BUILD ARGS)
        run: |
          docker build \
            --build-arg NEXT_PUBLIC_SUPABASE_URL="${{ secrets.SUPABASE_URL }}" \
            --build-arg NEXT_PUBLIC_SUPABASE_ANON_KEY="${{ secrets.SUPABASE_ANON_KEY }}" \
            -t beertaste-v2:latest ./client

      - name: Przygotowanie folderu Projects
        run: |
          mkdir -p /home/wojciech/projects/beertaste-v2
          cp docker-compose.prod.yml /home/wojciech/projects/beertaste-v2/docker-compose.yml

      - name: Tworzenie pliku .env dla kontenera
        working-directory: /home/wojciech/projects/beertaste-v2
        run: |
          echo "NEXT_PUBLIC_SUPABASE_URL=${{ secrets.SUPABASE_URL }}" > .env
          echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> .env

      - name: Sprzątanie starych kontenerów
        run: |
          docker stop beertaste-client || true
          docker rm beertaste-client || true

      - name: Uruchomienie aplikacji (Docker Compose)
        working-directory: /home/wojciech/projects/beertaste-v2
        run: |
          docker compose down || true
          docker compose up -d --force-recreate